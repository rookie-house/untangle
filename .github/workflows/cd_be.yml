name: deploy be

on:
  push:
    branches:
      - main
    paths:
      - "apps/server/**"
      - ".github/workflows/cd_be.yml"

jobs:
  migrate:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[migrations]') ||
      contains(join(github.event.commits.*.modified), 'apps/server/drizzle') ||
      contains(join(github.event.commits.*.modified), 'apps/server/migrations') ||
      contains(join(github.event.commits.*.modified), '.sql')
    defaults:
      run:
        working-directory: apps/server
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run migrations
        run: |
          echo "Migration files changed, running migrations..."
          pnpm drizzle:generate
          pnpm drizzle:migrate
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}

  deploy:
    runs-on: ubuntu-latest
    needs: [migrate]
    if: contains(join(github.event.commits.*.modified), 'apps/server/')
    defaults:
      run:
        working-directory: apps/server
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate wrangler.jsonc
        run: |
          cat > wrangler.jsonc <<EOF
          {
            "name": "be-bonk-bot",
            "account_id": "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}",
            "main": "src/index.ts",
            "compatibility_date": "$(date +%Y-%m-%d)",
            "compatibility_flags": ["nodejs_compat"],
            "vars": {
              "TURSO_DATABASE_URL": "${{ secrets.TURSO_DATABASE_URL }}",
              "TURSO_AUTH_TOKEN": "${{ secrets.TURSO_AUTH_TOKEN }}",
              "SALT": "${{ secrets.SALT }}",
              "JWT_SECRET": "${{ secrets.BE_JWT_SECRET }}",
              "GOOGLE_CLIENT_ID": "${{ secrets.GOOGLE_CLIENT_ID }}",
              "GOOGLE_CLIENT_SECRET": "${{ secrets.GOOGLE_CLIENT_SECRET }}",
              "GOOGLE_REDIRECT_URI": "${{ secrets.GOOGLE_REDIRECT_URI }}",
              "FRONTEND_URL": "${{ vars.FRONTEND_URL }}"
            }
          }
          EOF

      - name: Deploy to Workers
        run: pnpm wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
